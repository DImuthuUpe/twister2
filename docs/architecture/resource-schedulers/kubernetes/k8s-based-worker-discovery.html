<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>architecture/resource-schedulers/kubernetes/k8s-based-worker-discovery · Twister2</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# K8s Based Worker Discovery"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="architecture/resource-schedulers/kubernetes/k8s-based-worker-discovery · Twister2"/><meta property="og:type" content="website"/><meta property="og:url" content="https://twister2.org/"/><meta property="og:description" content="# K8s Based Worker Discovery"/><meta property="og:image" content="https://twister2.org/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://twister2.org/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"/><link rel="alternate" type="application/atom+xml" href="https://twister2.org/blog/atom.xml" title="Twister2 Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://twister2.org/blog/feed.xml" title="Twister2 Blog RSS Feed"/><link rel="stylesheet" href="/css/code-blocks-buttons.css"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat|Oswald|Roboto&amp;display=swap"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="/js/code-blocks-buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo_large.png" alt="Twister2"/><h2 class="headerTitleWithLogo">Twister2</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/introduction" target="_self">Getting Started</a></li><li class=""><a href="/docs/compiling/compile_overview" target="_self">Docs</a></li><li class=""><a href="/docs/examples/tset/hello_world" target="_self">Tutorial</a></li><li class=""><a href="/docs/examples/examples" target="_self">Examples</a></li><li class=""><a href="/docs/developers/debugging" target="_self">Contributors</a></li><li class=""><a href="/docs/download" target="_self">Download</a></li><li class=""><a href="/configs" target="_self">Configurations</a></li><li class=""><a href="https://github.com/DSC-SPIDAL/twister2" target="_blank">GitHub</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">architecture/resource-schedulers/kubernetes/k8s-based-worker-discovery</h1></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="k8s-based-worker-discovery"></a><a href="#k8s-based-worker-discovery" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>K8s Based Worker Discovery</h1>
<p>We developed a worker controller that watches the pods in Kubernetes clusters by listening to Kubernetes master. It provides the following services to workers in a Twister2 job:</p>
<ul>
<li>Unique ID assignment to workers</li>
<li>Worker address discovery</li>
<li>Getting the IP addresses after the worker pods started running</li>
</ul>
<p>This class does not implement the barriers for workers.
This class does not support NodeInfo and ComputeResource discovery.</p>
<p>The worker discoverer class is:</p>
<ul>
<li><a href="https://github.com/DSC-SPIDAL/twister2/tree/d9edff9bac47239db44731064aa5e2ac98867d97/twister2/resource-scheduler/src/java/edu/iu/dsc/tws/rsched/schedulers/k8s/worker/K8sWorkerController.java">edu.iu.dsc.tws.rsched.schedulers.k8s.worker.K8sWorkerController</a></li>
</ul>
<p>It implements interface:</p>
<ul>
<li><a href="https://github.com/DSC-SPIDAL/twister2/tree/d9edff9bac47239db44731064aa5e2ac98867d97/docs/documentation/twister2/common/src/java/edu/iu/dsc/tws/common/discovery/IWorkerController.java">edu.iu.dsc.tws.common.controller.IWorkerController</a></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="unique-id-assignment-to-workers"></a><a href="#unique-id-assignment-to-workers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Unique ID Assignment to Workers</h2>
<p>Worker IDs in a Twister2 job start from 0 and increase sequentially without any gaps in between.</p>
<p>Each pod in Twister2 jobs has a unique name with a unique integer extension. When there are n pods in a job (StatefulSet), each pod name is composed of -. Index starts from zero and increases sequentially. Kubernetes master assigns these pod indexes. Each container is also assigned a name that is similar to the pod names. Container names are in the form of -. Again the index starts from zero and increases sequentially in each pod. While pod indexes are assigned by Kubernetes master, we assign the container name indexes when we create the StatefulSets.</p>
<p>We construct unique worker IDs by using pod name and container name indexes. The worker ID generated by the formula:</p>
<pre><code class="hljs css language-text">workerID = (podIndex x ContainersPerPod) + containerIndex
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="worker-ip-and-port-numbers"></a><a href="#worker-ip-and-port-numbers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Worker IP and Port Numbers</h2>
<p>Each worker needs to have a unique : combination. Currently each worker has one TCP port. More ports can be added later on as needed.</p>
<p>Each worker uses the IP addresses of the pod it is running in as its IP address. IP address of each pod can be either get by using localhost or sent to the containers as an environment variable using downward API call, when submitting the job.</p>
<p>The port number of each non-MPI enabled worker is calculated as the basePort + containerIndex. When there are multiple containers in a pod, each container has an increasing index starting from 0.</p>
<p>The port number of MPI enabled workers are calculate as the basePort + MPI ranking.</p>
<h3><a class="anchor" aria-hidden="true" id="watching-workers-to-start"></a><a href="#watching-workers-to-start" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Watching Workers to Start</h3>
<p>Each worker watches pod running events and when a pod reaches to “Running” phase, they assume that all workers in that pod started running. This is not %100 accurate. It is a close assumption.<br>
A pod may have started but some workers in that may have not started yet or stalled at some point. This worker discoverer does not distinguish pod Running and worker starts.</p>
<p>Job Master based worker discoverer provides a more precise discovery method. In that case, each worker reports its status. Therefore, it is more accurate. The advantage of this one is that it works in the absence of the Job Master also.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#unique-id-assignment-to-workers">Unique ID Assignment to Workers</a></li><li><a href="#worker-ip-and-port-numbers">Worker IP and Port Numbers</a><ul class="toc-headings"><li><a href="#watching-workers-to-start">Watching Workers to Start</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo_large.png" alt="Twister2" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/en/quickstart.html">Getting Started (Quickstart)</a><a href="/docs/en/concepts/api_overview">Guides (Programming Guides)</a></div><div><h5>Community</h5><a href="https://stackoverflow.com/questions/tagged/" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://dsc-twister.slack.com/">Project Chat</a></div><div><h5>More</h5><a href="/blog">Blog</a><a href="https://github.com/DSC-SPIDAL/twister2">GitHub</a><a class="github-button" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2019 Indiana University</section></footer></div></body></html>